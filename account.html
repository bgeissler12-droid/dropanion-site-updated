<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dropanion — Account</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b0f14; --card:#121820; --text:#fff; --muted:#9fb3c8; --blue:#2A80F7; --green:#1F7A75; --border:#1d2630; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
    .card { width: 100%; max-width: 520px; background: var(--card); border:1px solid var(--border); border-radius: 16px; padding: 22px; box-shadow: 0 10px 28px rgba(0,0,0,.35); }
    h1 { margin: 8px 0 14px; font-size: 26px; font-weight: 800; text-align:center; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { font-size: 13px; color: var(--muted); display:block; margin-bottom: 6px; }
    input { width: 100%; padding: 12px 14px; border-radius: 10px; border:1px solid var(--border); background:#0e1419; color:#fff; }
    .btn { width: 100%; padding: 12px 14px; border-radius: 12px; border: none; cursor: pointer; font-weight: 800; }
    .btn.primary { background: var(--blue); color: #fff; }
    .btn.secondary { background: transparent; color: #cbd5e1; border:1px solid var(--border); }
    .muted { color: var(--muted); font-size: 13px; text-align:center; }
    .hr { height:1px; background: var(--border); margin: 12px 0; }
    .top-right { position: fixed; top: 10px; right: 16px; }
    .error { color: #f87171; font-size: 13px; margin-top: 6px; min-height: 18px; }
    .success { color: #34d399; font-size: 13px; margin-top: 6px; min-height: 18px; }
    .hidden { display:none !important; }
    .center { text-align:center; }
    .plan { display:flex; align-items:center; justify-content:space-between; border:1px solid var(--border); border-radius:12px; padding:12px 14px; margin-top:10px; background:#0f1317; }
    .pill { background: var(--blue); color:#fff; border-radius:999px; padding:.25rem .6rem; font-weight:800; font-size:12px; }
    .plans { margin-top: 6px; }
    .cta-row { display:flex; gap:10px; margin-top: 14px; }
  </style>
</head>
<body>
  <a class="top-right muted" href="/">← Back to website</a>
  <div class="wrap">
    <div class="card" id="authCard">
      <h1 id="formTitle">Create an account</h1>
      <div class="row">
        <div>
          <label for="firstName">First name</label>
          <input id="firstName" placeholder="Max">
        </div>
        <div>
          <label for="lastName">Last name</label>
          <input id="lastName" placeholder="Robinson">
        </div>
      </div>
      <div style="margin-top:10px;">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="m@example.com" autocomplete="email">
      </div>
      <div style="margin-top:10px;">
        <label for="password">Password</label>
        <input id="password" type="password" placeholder="••••••••" autocomplete="new-password">
      </div>
      <div id="authError" class="error"></div>
      <div class="cta-row">
        <button id="registerBtn" class="btn primary">Register</button>
        <button id="toggleBtn" class="btn secondary">Have an account? Log in</button>
      </div>
      <div class="hr"></div>
      <div class="center">
        <button id="googleBtn" class="btn secondary" style="max-width:320px;">Continue with Google</button>
        <p class="muted" style="margin-top:10px;">By clicking continue, you agree to our <a href="/terms.html" target="_blank">Terms</a> & <a href="/privacy.html" target="_blank">Privacy</a>.</p>
      </div>
    </div>

    <div class="card hidden" id="plansCard">
      <h1>Choose your plan</h1>
      <p class="muted center" id="welcomeTxt">Welcome! Select a package to continue.</p>
      <div class="plans">
        <div class="plan"><div><strong>Starter</strong><div class="muted">For getting started</div></div><input type="radio" name="plan" value="starter"></div>
        <div class="plan"><div><strong>Growth</strong><div class="muted">For scaling up</div></div><input type="radio" name="plan" value="growth"></div>
        <div class="plan"><div><strong>Pro</strong><div class="muted">For power users</div></div><input type="radio" name="plan" value="pro"></div>
        <div class="plan"><div><span class="pill">Enterprise</span> <strong style="margin-left:8px;">15k Listings</strong></div><input type="radio" name="plan" value="15k"></div>
        <div class="plan"><div><span class="pill">Enterprise</span> <strong style="margin-left:8px;">25k Listings</strong></div><input type="radio" name="plan" value="25k"></div>
        <div class="plan"><div><span class="pill">Enterprise</span> <strong style="margin-left:8px;">35k Listings</strong></div><input type="radio" name="plan" value="35k"></div>
        <div class="plan"><div><span class="pill">Enterprise</span> <strong style="margin-left:8px;">50k Listings</strong></div><input type="radio" name="plan" value="50k"></div>
      </div>
      <div class="cta-row">
        <button id="continueBtn" class="btn primary">Continue to checkout</button>
        <button id="logoutBtn" class="btn secondary">Log out</button>
      </div>
      <div id="planError" class="error"></div>
      <div id="planSuccess" class="success"></div>
    </div>
  </div>

  <!-- Firebase (modular v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // 1) Paste your Firebase config here
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID",
    };

    // 2) Stripe Payment Links (LIVE)
    const PAYMENT_LINKS = {
      starter: "https://buy.stripe.com/5kQaEX6IgcBdaHMaOa6kg07",
      growth:  "https://buy.stripe.com/cNicN59Usbx99DI9K66kg08",
      pro:     "https://buy.stripe.com/9B68wPfeMat57vAf4q6kg09",
      "15k":   "https://buy.stripe.com/eVq5kDeaIgRteY22hE6kg0a",
      "25k":   "https://buy.stripe.com/bJedR9giQbx9dTYf4q6kg0b",
      "35k":   "https://buy.stripe.com/aFa4gz5EceJldTY4pM6kg0c",
      "50k":   "https://buy.stripe.com/9B63cv5EcgRteY2bSe6kg0d",
    };

    // Optional: TEST links (fill if you create test Payment Links)
    const TEST_PAYMENT_LINKS = {
      starter: "", growth: "", pro: "", "15k":"", "25k":"", "35k":"", "50k":""
    };

    // Decide which set to use (localhost/staging use TEST if available)
    const isLocal = location.hostname === "localhost" || location.hostname.includes("127.0.0.1");
    const LINKS = (isLocal && Object.values(TEST_PAYMENT_LINKS).some(v => v)) ? TEST_PAYMENT_LINKS : PAYMENT_LINKS;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // UI helpers
    const $ = id => document.getElementById(id);
    const authCard = $("authCard");
    const plansCard = $("plansCard");
    const formTitle = $("formTitle");
    const authError = $("authError");
    const planError = $("planError");
    const planSuccess = $("planSuccess");
    const toggleBtn = $("toggleBtn");
    const registerBtn = $("registerBtn");
    const googleBtn = $("googleBtn");
    const continueBtn = $("continueBtn");
    const logoutBtn = $("logoutBtn");
    const firstName = $("firstName");
    const lastName = $("lastName");
    const email = $("email");
    const password = $("password");

    let mode = "register"; // or "login"

    toggleBtn.addEventListener("click", () => {
      if (mode === "register") {
        mode = "login";
        formTitle.textContent = "Log in";
        toggleBtn.textContent = "Need an account? Register";
        registerBtn.textContent = "Log in";
        firstName.parentElement.classList.add("hidden");
        lastName.parentElement.classList.add("hidden");
        password.setAttribute("autocomplete","current-password");
      } else {
        mode = "register";
        formTitle.textContent = "Create an account";
        toggleBtn.textContent = "Have an account? Log in";
        registerBtn.textContent = "Register";
        firstName.parentElement.classList.remove("hidden");
        lastName.parentElement.classList.remove("hidden");
        password.setAttribute("autocomplete","new-password");
      }
      authError.textContent = "";
    });

    registerBtn.addEventListener("click", async () => {
      authError.textContent = "";
      try {
        if (mode === "register") {
          if (!email.value || !password.value) throw new Error("Enter email & password");
          const cred = await createUserWithEmailAndPassword(auth, email.value.trim(), password.value);
          if (firstName.value || lastName.value) {
            await updateProfile(cred.user, { displayName: (firstName.value + " " + lastName.value).trim() });
          }
        } else {
          await signInWithEmailAndPassword(auth, email.value.trim(), password.value);
        }
      } catch (e) {
        authError.textContent = e.message || "Could not authenticate";
      }
    });

    googleBtn.addEventListener("click", async () => {
      authError.textContent = "";
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (e) {
        authError.textContent = e.message || "Google sign-in failed";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Show plans
        authCard.classList.add("hidden");
        plansCard.classList.remove("hidden");
        document.getElementById("welcomeTxt").textContent = `Welcome, ${user.email}! Choose your package to continue.`;
      } else {
        // Show auth
        plansCard.classList.add("hidden");
        authCard.classList.remove("hidden");
      }
    });

    continueBtn.addEventListener("click", () => {
      planError.textContent = "";
      planSuccess.textContent = "";
      const selected = document.querySelector('input[name="plan"]:checked');
      if (!selected) {
        planError.textContent = "Please select a plan.";
        return;
      }
      const planKey = selected.value;
      const link = LINKS[planKey];
      if (!link) {
        planError.textContent = "This plan is not available.";
        return;
      }
      const user = auth.currentUser;
      if (!user) {
        planError.textContent = "Please sign in again.";
        return;
      }
      // Build URL with prefilled email; add client_reference_id if supported
      const params = new URLSearchParams();
      params.set("prefilled_email", user.email);
      // Stripe may ignore client_reference_id on Payment Links; safe to include.
      params.set("client_reference_id", user.uid);
      const url = link + (link.includes("?") ? "&" : "?") + params.toString();
      planSuccess.textContent = "Redirecting to secure checkout...";
      location.href = url;
    });
  </script>
</body>
</html>
